app.widget.directive('book', function($compile) {
  var DOM = {
    addPage: function(scope, book) {
      var $book = $(book);
      var pageNumber = $book.children().size() - 1;
      var html = '<page class="' + DOM.getClass(pageNumber) + '" placeholder="data[' + (pageNumber - 1) + ']"></page>';
      $book.children().last().before($compile(html)(scope));
    },
    getClass: function(pageNumber) {
      var className = [];
      if(pageNumber == 2) {
        className.push('hard');
      }
      className.push(pageNumber % 2 ? 'even' : 'odd');
      className.push('p' + pageNumber);
      return className.join(' ');
    }
  };
  return {
    restrict: 'E',
    replace: true,
    templateUrl: '<%= asset_path "html4/_book.html"  %>',
    scope: {
      data: '=placeholder'
    },
    link: function(scope, element, attrs) {
      var init = function(scopeData, data) {
        switch(data.about.type) {
          case "serie":   return $.extend(scopeData, { 'id': data.serie.id, 'name' : data.serie.name });
          case "product": return $.extend(scopeData, { 'id': data.product.id, 'name' : data.product.name });
        }
      }
      scope.$watch('data', function(data) {
        if(data) {
          for(var i=0; i<data.length; i++) {
            init(scope.data[i].about, data[i]);
            DOM.addPage(scope, element)
          }
        }
      })
    }
  }
});
